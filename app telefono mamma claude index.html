<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Nonna</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: Arial, sans-serif;
            background: #000000;
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
        }

        .container {
            width: 100%;
            max-width: 500px;
            height: 100vh;
            background: #FFFFFF;
            display: flex;
            flex-direction: column;
            position: relative;
        }

        .header {
            background: #000000;
            color: #FFFF00;
            padding: 25px 20px;
            text-align: center;
            border-bottom: 5px solid #FFFF00;
            position: relative;
        }

        .header h1 {
            font-size: 48px;
            font-weight: bold;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
        }

        .header p {
            font-size: 26px;
            margin-top: 8px;
        }

        .settings-btn {
            position: absolute;
            top: 20px;
            right: 20px;
            background: #FFFF00;
            color: #000000;
            border: 3px solid #000000;
            padding: 12px 20px;
            font-size: 24px;
            font-weight: bold;
            border-radius: 10px;
            cursor: pointer;
        }

        .main-screen {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 20px;
            position: relative;
            overflow-y: auto;
        }

        .status-text {
            font-size: 36px;
            font-weight: bold;
            text-align: center;
            color: #000000;
            margin-bottom: 30px;
            min-height: 80px;
            display: flex;
            align-items: center;
            justify-content: center;
            line-height: 1.3;
            text-shadow: 1px 1px 2px rgba(255,255,255,0.5);
        }

        .main-button {
            width: 260px;
            height: 260px;
            border-radius: 50%;
            border: 6px solid #000000;
            font-size: 38px;
            font-weight: bold;
            color: #000000;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 8px 20px rgba(0,0,0,0.4);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 12px;
        }

        .main-button.green {
            background: #FFFF00;
        }

        .main-button.green:active {
            transform: scale(0.95);
            background: #FFCC00;
        }

        .main-button.red {
            background: #FF0000;
            color: #FFFFFF;
            border-color: #000000;
            width: 180px;
            height: 180px;
            font-size: 32px;
        }

        .icon {
            font-size: 80px;
            filter: drop-shadow(2px 2px 3px rgba(0,0,0,0.3));
        }

        .contacts-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            padding: 15px;
            width: 100%;
            max-width: 500px;
            overflow-y: auto;
            max-height: calc(100vh - 200px);
        }

        .contact-btn {
            background: #FFFFFF;
            border: 5px solid #000000;
            border-radius: 20px;
            padding: 25px 15px;
            font-size: 26px;
            font-weight: bold;
            color: #000000;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 12px;
            min-height: 160px;
            box-shadow: 0 6px 15px rgba(0,0,0,0.3);
            position: relative;
        }

        .contact-btn.yellow { background: #FFFF00; }
        .contact-btn.cyan { background: #00FFFF; }
        .contact-btn.magenta { background: #FF00FF; }
        .contact-btn.orange { background: #FF9900; }
        .contact-btn.lime { background: #00FF00; }
        .contact-btn.pink { background: #FF69B4; }
        .contact-btn.violet { background: #9933FF; }
        .contact-btn.gold { background: #FFD700; }

        .contact-btn:active {
            transform: scale(0.95);
            box-shadow: 0 3px 10px rgba(0,0,0,0.4);
        }

        .contact-icon {
            font-size: 52px;
            filter: drop-shadow(2px 2px 3px rgba(0,0,0,0.3));
        }

        .contact-name {
            font-size: 24px;
            text-align: center;
            line-height: 1.2;
        }

        .add-contact-btn {
            background: #00FF00;
            border: 5px dashed #000000;
        }

        .quick-call-badge {
            position: absolute;
            top: 10px;
            right: 10px;
            background: #FF0000;
            color: #FFFFFF;
            padding: 5px 10px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: bold;
        }

        .hidden {
            display: none !important;
        }

        .response-options {
            display: flex;
            gap: 20px;
            margin-top: 25px;
            width: 100%;
            max-width: 400px;
        }

        .response-btn {
            flex: 1;
            padding: 30px;
            font-size: 40px;
            font-weight: bold;
            border: 5px solid #000000;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: 0 6px 15px rgba(0,0,0,0.3);
        }

        .response-btn.yes {
            background: #00FF00;
            color: #000000;
        }

        .response-btn.no {
            background: #FF0000;
            color: #FFFFFF;
        }

        .response-btn:active {
            transform: scale(0.95);
        }

        .calling-animation {
            width: 180px;
            height: 180px;
            border: 10px solid #000000;
            background: #FFFF00;
            border-radius: 50%;
            margin: 20px auto;
            position: relative;
            animation: ring 1s infinite;
        }

        @keyframes ring {
            0%, 100% {
                transform: scale(1);
                box-shadow: 0 0 30px rgba(255, 255, 0, 0.8);
            }
            50% {
                transform: scale(1.1);
                box-shadow: 0 0 50px rgba(255, 255, 0, 1);
            }
        }

        .calling-animation::before {
            content: "üìû";
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 70px;
        }

        /* Modal */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .modal-content {
            background: #FFFFFF;
            border: 5px solid #FFFF00;
            border-radius: 20px;
            padding: 30px;
            width: 90%;
            max-width: 450px;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-title {
            font-size: 32px;
            font-weight: bold;
            color: #000000;
            margin-bottom: 20px;
            text-align: center;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            font-size: 24px;
            font-weight: bold;
            color: #000000;
            display: block;
            margin-bottom: 10px;
        }

        .form-input {
            width: 100%;
            padding: 15px;
            font-size: 22px;
            border: 3px solid #000000;
            border-radius: 10px;
            background: #FFFF00;
            color: #000000;
            font-weight: bold;
        }

        .form-select {
            width: 100%;
            padding: 15px;
            font-size: 22px;
            border: 3px solid #000000;
            border-radius: 10px;
            background: #00FFFF;
            color: #000000;
            font-weight: bold;
        }

        .form-checkbox {
            width: 30px;
            height: 30px;
            margin-right: 15px;
            cursor: pointer;
        }

        .checkbox-label {
            display: flex;
            align-items: center;
            font-size: 22px;
            font-weight: bold;
            cursor: pointer;
            padding: 15px;
            background: #FFFF00;
            border: 3px solid #000000;
            border-radius: 10px;
        }

        .btn-save {
            background: #00FF00;
            color: #000000;
            border: 5px solid #000000;
            padding: 20px;
            font-size: 28px;
            font-weight: bold;
            border-radius: 15px;
            cursor: pointer;
            width: 100%;
            margin-top: 20px;
        }

        .btn-cancel {
            background: #FF0000;
            color: #FFFFFF;
            border: 5px solid #000000;
            padding: 20px;
            font-size: 28px;
            font-weight: bold;
            border-radius: 15px;
            cursor: pointer;
            width: 100%;
            margin-top: 10px;
        }

        .btn-secondary {
            background: #00FFFF;
            color: #000000;
            border: 5px solid #000000;
            padding: 20px;
            font-size: 24px;
            font-weight: bold;
            border-radius: 15px;
            cursor: pointer;
            width: 100%;
            margin-top: 10px;
        }

        .contact-list {
            margin-top: 20px;
        }

        .contact-item {
            background: #FFFF00;
            border: 3px solid #000000;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .contact-info {
            font-size: 20px;
            font-weight: bold;
            flex: 1;
        }

        .contact-actions {
            display: flex;
            gap: 10px;
        }

        .btn-delete, .btn-edit {
            background: #FF0000;
            color: #FFFFFF;
            border: 3px solid #000000;
            padding: 10px 15px;
            font-size: 20px;
            font-weight: bold;
            border-radius: 8px;
            cursor: pointer;
        }

        .btn-edit {
            background: #00FFFF;
            color: #000000;
        }

        .menu-buttons {
            display: grid;
            gap: 15px;
            margin-bottom: 20px;
        }

        .file-input {
            display: none;
        }

        .import-list {
            max-height: 300px;
            overflow-y: auto;
            border: 3px solid #000000;
            border-radius: 10px;
            padding: 10px;
            background: #FFFFFF;
        }

        .import-item {
            display: flex;
            align-items: center;
            padding: 12px;
            border-bottom: 2px solid #000000;
            font-size: 18px;
        }

        .import-item:last-child {
            border-bottom: none;
        }

        .high-contrast {
            filter: contrast(1.2);
        }
    </style>
</head>
<body>
    <div class="container high-contrast">
        <div class="header">
            <h1>üëµ NONNA</h1>
            <p>Assistente Vocale</p>
            <button class="settings-btn" onclick="openSettings()">‚öôÔ∏è</button>
        </div>

        <!-- Griglia Contatti -->
        <div class="contacts-grid" id="contactsGrid">
            <button class="contact-btn add-contact-btn" onclick="addNewContact()">
                <span class="contact-icon">‚ûï</span>
                <span class="contact-name">AGGIUNGI<br>CONTATTO</span>
            </button>
        </div>

        <!-- Schermata Conferma -->
        <div class="main-screen hidden" id="confirmScreen">
            <div class="status-text" id="confirmText">
                CHIAMO MARIA.<br>CONFERMI?
            </div>
            <div class="response-options">
                <button class="response-btn yes" onclick="confirmAction(true)">
                    S√å
                </button>
                <button class="response-btn no" onclick="confirmAction(false)">
                    NO
                </button>
            </div>
        </div>

        <!-- Schermata Chiamata -->
        <div class="main-screen hidden" id="callingScreen">
            <div class="status-text">
                CHIAMO ADESSO...
            </div>
            <div class="calling-animation"></div>
            <div class="status-text" id="callingContact" style="font-size: 48px; color: #000000;">
                MARIA
            </div>
            <button class="main-button red" onclick="cancelCall()" style="margin-top: 30px;">
                ANNULLA
            </button>
        </div>
    </div>

    <!-- Modal Impostazioni Principale -->
    <div class="modal hidden" id="settingsModal">
        <div class="modal-content">
            <div class="modal-title">‚öôÔ∏è IMPOSTAZIONI</div>
            
            <div class="menu-buttons">
                <button class="btn-save" onclick="showContactManager()">
                    üìã GESTISCI CONTATTI
                </button>
                <button class="btn-secondary" onclick="showImportContacts()">
                    üì• IMPORTA DA RUBRICA
                </button>
                <button class="btn-secondary" onclick="exportBackup()">
                    üíæ BACKUP CONTATTI
                </button>
                <button class="btn-secondary" onclick="document.getElementById('importBackupFile').click()">
                    üìÇ RIPRISTINA BACKUP
                </button>
                <input type="file" id="importBackupFile" class="file-input" accept=".json" onchange="importBackup(event)">
            </div>
            
            <button class="btn-cancel" onclick="closeSettings()">CHIUDI</button>
        </div>
    </div>

    <!-- Modal Gestione Contatti -->
    <div class="modal hidden" id="contactManagerModal">
        <div class="modal-content">
            <div class="modal-title">üìã I TUOI CONTATTI</div>
            
            <div class="contact-list" id="contactList"></div>
            
            <button class="btn-cancel" onclick="closeContactManager()">CHIUDI</button>
        </div>
    </div>

    <!-- Modal Import Contatti dalla Rubrica -->
    <div class="modal hidden" id="importContactsModal">
        <div class="modal-content">
            <div class="modal-title">üì• IMPORTA CONTATTI</div>
            
            <p style="font-size: 20px; margin-bottom: 20px; text-align: center;">
                Nota: Su browser web, usa il backup/ripristino. L'accesso alla rubrica funziona solo su app native Android/iOS.
            </p>
            
            <button class="btn-save" onclick="requestContactsAccess()">
                üì± ACCEDI ALLA RUBRICA
            </button>
            
            <div id="importList" class="import-list hidden" style="margin-top: 20px;">
                <!-- Lista contatti importabili -->
            </div>
            
            <button class="btn-secondary hidden" id="confirmImportBtn" onclick="confirmContactsImport()">
                ‚úì IMPORTA SELEZIONATI
            </button>
            
            <button class="btn-cancel" onclick="closeImportContacts()">CHIUDI</button>
        </div>
    </div>

    <!-- Modal Aggiungi/Modifica Contatto -->
    <div class="modal hidden" id="addContactModal">
        <div class="modal-content">
            <div class="modal-title" id="contactModalTitle">‚ûï AGGIUNGI CONTATTO</div>
            
            <div class="form-group">
                <label class="form-label">NOME:</label>
                <input type="text" class="form-input" id="contactName" placeholder="Es: Maria">
            </div>
            
            <div class="form-group">
                <label class="form-label">NUMERO TELEFONO:</label>
                <input type="tel" class="form-input" id="contactPhone" placeholder="Es: 3331234567">
            </div>
            
            <div class="form-group">
                <label class="form-label">ICONA:</label>
                <select class="form-select" id="contactIcon">
                    <option value="üë®">üë® Uomo</option>
                    <option value="üë©">üë© Donna</option>
                    <option value="üëß">üëß Bambina</option>
                    <option value="üë¶">üë¶ Bambino</option>
                    <option value="üëµ">üëµ Nonna</option>
                    <option value="üë¥">üë¥ Nonno</option>
                    <option value="üë©‚Äç‚öïÔ∏è">üë©‚Äç‚öïÔ∏è Dottoressa</option>
                    <option value="üë®‚Äç‚öïÔ∏è">üë®‚Äç‚öïÔ∏è Dottore</option>
                    <option value="üíä">üíä Farmacia</option>
                    <option value="üö®">üö® Emergenza</option>
                    <option value="‚ù§Ô∏è">‚ù§Ô∏è Cuore</option>
                    <option value="‚≠ê">‚≠ê Stella</option>
                </select>
            </div>
            
            <div class="form-group">
                <label class="form-label">COLORE:</label>
                <select class="form-select" id="contactColor">
                    <option value="yellow">Giallo</option>
                    <option value="cyan">Ciano</option>
                    <option value="magenta">Magenta</option>
                    <option value="orange">Arancione</option>
                    <option value="lime">Verde Lime</option>
                    <option value="pink">Rosa</option>
                    <option value="violet">Viola</option>
                    <option value="gold">Oro</option>
                </select>
            </div>
            
            <div class="form-group">
                <label class="checkbox-label">
                    <input type="checkbox" class="form-checkbox" id="quickCallCheck">
                    <span>CHIAMATA RAPIDA (senza conferma)</span>
                </label>
                <p style="font-size: 16px; margin-top: 10px; color: #666;">
                    ‚ö†Ô∏è Attivare solo per caregiver/familiari di fiducia
                </p>
            </div>
            
            <button class="btn-save" onclick="saveContact()">SALVA</button>
            <button class="btn-cancel" onclick="closeAddContact()">ANNULLA</button>
        </div>
    </div>

    <script>
        let contacts = [];
        let editingIndex = -1;
        let selectedImportContacts = [];

        // Carica contatti all'avvio
        function loadContacts() {
            const saved = localStorage.getItem('nonnaContacts');
            if (saved) {
                contacts = JSON.parse(saved);
            } else {
                contacts = [
                    { name: 'Emergenza 112', phone: '112', icon: 'üö®', color: 'gold', quickCall: false }
                ];
                saveContactsToStorage();
            }
            renderContacts();
        }

        function saveContactsToStorage() {
            localStorage.setItem('nonnaContacts', JSON.stringify(contacts));
        }

        function renderContacts() {
            const grid = document.getElementById('contactsGrid');
            grid.innerHTML = '';

            contacts.forEach((contact, index) => {
                const btn = document.createElement('button');
                btn.className = `contact-btn ${contact.color}`;
                btn.onclick = () => quickCall(contact);
                
                let badge = '';
                if (contact.quickCall) {
                    badge = '<span class="quick-call-badge">RAPIDA</span>';
                }
                
                btn.innerHTML = `
                    ${badge}
                    <span class="contact-icon">${contact.icon}</span>
                    <span class="contact-name">${contact.name.toUpperCase()}</span>
                `;
                grid.appendChild(btn);
            });

            const addBtn = document.createElement('button');
            addBtn.className = 'contact-btn add-contact-btn';
            addBtn.onclick = addNewContact;
            addBtn.innerHTML = `
                <span class="contact-icon">‚ûï</span>
                <span class="contact-name">AGGIUNGI<br>CONTATTO</span>
            `;
            grid.appendChild(addBtn);
        }

        // ========== GESTIONE CONTATTI ==========
        function addNewContact() {
            editingIndex = -1;
            document.getElementById('contactModalTitle').textContent = '‚ûï AGGIUNGI CONTATTO';
            document.getElementById('contactName').value = '';
            document.getElementById('contactPhone').value = '';
            document.getElementById('contactIcon').value = 'üë®';
            document.getElementById('contactColor').value = 'yellow';
            document.getElementById('quickCallCheck').checked = false;
            document.getElementById('addContactModal').classList.remove('hidden');
        }

        function saveContact() {
            const name = document.getElementById('contactName').value.trim();
            const phone = document.getElementById('contactPhone').value.trim();
            const icon = document.getElementById('contactIcon').value;
            const color = document.getElementById('contactColor').value;
            const quickCall = document.getElementById('quickCallCheck').checked;

            if (!name) {
                alert('Inserisci un nome per il contatto!');
                return;
            }

            if (!phone) {
                alert('Inserisci un numero di telefono!');
                return;
            }

            const contact = { name, phone, icon, color, quickCall };

            if (editingIndex >= 0) {
                contacts[editingIndex] = contact;
                speak(`Contatto ${name} modificato`);
            } else {
                contacts.push(contact);
                speak(`Contatto ${name} aggiunto`);
            }

            saveContactsToStorage();
            renderContacts();
            closeAddContact();
        }

        function editContact(index) {
            editingIndex = index;
            const contact = contacts[index];
            
            document.getElementById('contactModalTitle').textContent = '‚úèÔ∏è MODIFICA CONTATTO';
            document.getElementById('contactName').value = contact.name;
            document.getElementById('contactPhone').value = contact.phone;
            document.getElementById('contactIcon').value = contact.icon;
            document.getElementById('contactColor').value = contact.color;
            document.getElementById('quickCallCheck').checked = contact.quickCall || false;
            
            closeContactManager();
            document.getElementById('addContactModal').classList.remove('hidden');
        }

        function deleteContact(index) {
            if (confirm(`Vuoi eliminare ${contacts[index].name}?`)) {
                const deletedName = contacts[index].name;
                contacts.splice(index, 1);
                saveContactsToStorage();
                renderContacts();
                renderContactList();
                speak(`Contatto ${deletedName} eliminato`);
            }
        }

        function closeAddContact() {
            document.getElementById('addContactModal').classList.add('hidden');
            editingIndex = -1;
        }

        // ========== IMPORT DA RUBRICA ==========
        function showImportContacts() {
            document.getElementById('settingsModal').classList.add('hidden');
            document.getElementById('importContactsModal').classList.remove('hidden');
        }

        function closeImportContacts() {
            document.getElementById('importContactsModal').classList.add('hidden');
            document.getElementById('importList').classList.add('hidden');
            document.getElementById('confirmImportBtn').classList.add('hidden');
            selectedImportContacts = [];
        }

        async function requestContactsAccess() {
            // NOTA: La Contact Picker API funziona solo su browser supportati (Chrome Android, Safari iOS con limitazioni)
            if ('contacts' in navigator && 'ContactsManager' in window) {
                try {
                    const props = ['name', 'tel'];
                    const opts = { multiple: true };
                    
                    const contacts = await navigator.contacts.select(props, opts);
                    displayImportableContacts(contacts);
                } catch (err) {
                    alert('Errore accesso rubrica: ' + err.message + '\n\nProva con Backup/Ripristina invece.');
                }
            } else {
                alert('Il browser non supporta l\'accesso alla rubrica.\n\nUSA INVECE:\n- BACKUP per salvare i contatti\n- RIPRISTINA per caricarli su un altro dispositivo');
            }
        }

        function displayImportableContacts(phoneContacts) {
            const list = document.getElementById('importList');
            list.innerHTML = '';
            selectedImportContacts = [];

            if (phoneContacts.length === 0) {
                list.innerHTML = '<p style="text-align:center; padding:20px;">Nessun contatto selezionato</p>';
                return;
            }

            phoneContacts.forEach((contact, index) => {
                const name = contact.name?.[0] || 'Sconosciuto';
                const phone = contact.tel?.[0] || '';

                if (!phone) return; // Salta contatti senza numero

                const item = document.createElement('div');
                item.className = 'import-item';
                item.innerHTML = `
                    <input type="checkbox" id="import_${index}" class="form-checkbox" 
                           onchange="toggleImportContact(${index}, '${name}', '${phone}')">
                    <label for="import_${index}" style="flex:1; cursor:pointer;">
                        <strong>${name}</strong><br>
                        <small>${phone}</small>
                    </label>
                `;
                list.appendChild(item);
            });

            list.classList.remove('hidden');
            document.getElementById('confirmImportBtn').classList.remove('hidden');
        }

        function toggleImportContact(index, name, phone) {
            const checkbox = document.getElementById(`import_${index}`);
            if (checkbox.checked) {
                selectedImportContacts.push({ name, phone });
            } else {
                selectedImportContacts = selectedImportContacts.filter(c => c.phone !== phone);
            }
        }

        function confirmContactsImport() {
            if (selectedImportContacts.length === 0) {
                alert('Seleziona almeno un contatto da importare!');
                return;
            }

            const colors = ['yellow', 'cyan', 'magenta', 'orange', 'lime', 'pink', 'violet', 'gold'];
            const icons = ['üë®', 'üë©', 'üëß', 'üë¶', 'üëµ', 'üë¥'];

            selectedImportContacts.forEach((contact, index) => {
                contacts.push({
                    name: contact.name,
                    phone: contact.phone,
                    icon: icons[index % icons.length],
                    color: colors[index % colors.length],
                    quickCall: false
                });
            });

            saveContactsToStorage();
            renderContacts();
            speak(`Importati ${selectedImportContacts.length} contatti`);
            closeImportContacts();
            closeSettings();
        }

        // ========== BACKUP E RIPRISTINO ==========
        function exportBackup() {
            const backup = {
                version: '1.0',
                date: new Date().toISOString(),
                contacts: contacts
            };

            const dataStr = JSON.stringify(backup, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);
            
            const link = document.createElement('a');
            link.href = url;
            link.download = `nonna-backup-${new Date().toISOString().split('T')[0]}.json`;
            link.click();
            
            URL.revokeObjectURL(url);
            speak('Backup salvato. Controlla i download.');
        }

        function importBackup(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const backup = JSON.parse(e.target.result);
                    
                    if (!backup.contacts || !Array.isArray(backup.contacts)) {
                        throw new Error('File backup non valido');
                    }

                    if (confirm(`Trovati ${backup.contacts.length} contatti.\n\nVuoi SOSTITUIRE i contatti attuali o AGGIUNGERE a quelli esistenti?\n\nOK = SOSTITUIRE\nANNULLA = AGGIUNGERE`)) {
                        // Sostituisci
                        contacts = backup.contacts;
                    } else {
                        // Aggiungi
                        backup.contacts.forEach(c => {
                            if (!contacts.find(existing => existing.phone === c.phone)) {
                                contacts.push(c);
                            }
                        });
                    }

                    saveContactsToStorage();
                    renderContacts();
                    speak('Backup ripristinato con successo');
                    closeSettings();
                } catch (err) {
                    alert('Errore nel ripristino: ' + err.message);
                }
            };
            reader.readAsText(file);
            
            // Reset input
            event.target.value = '';
        }

        // ========== MODALI ==========
        function openSettings() {
            document.getElementById('settingsModal').classList.remove('hidden');
        }

        function closeSettings() {
            document.getElementById('settingsModal').classList.add('hidden');
        }

        function showContactManager() {
            document.getElementById('settingsModal').classList.add('hidden');
            renderContactList();
            document.getElementById('contactManagerModal').classList.remove('hidden');
        }

        function closeContactManager() {
            document.getElementById('contactManagerModal').classList.add('hidden');
        }

        function renderContactList() {
            const list = document.getElementById('contactList');
            list.innerHTML = '';

            if (contacts.length === 0) {
                list.innerHTML = '<p style="text-align:center; font-size:20px; padding:20px;">Nessun contatto salvato</p>';
                return;
            }

            contacts.forEach((contact, index) => {
                const item = document.createElement('div');
                item.className = 'contact-item';
                
                let badge = '';
                if (contact.quickCall) {
                    badge = '<span style="background:#FF0000; color:#FFF; padding:2px 8px; border-radius:5px; font-size:14px; margin-left:10px;">RAPIDA</span>';
                }
                
                item.innerHTML = `
                    <div class="contact-info">
                        ${contact.icon} ${contact.name}${badge}<br>
                        <small>${contact.phone}</small>
                    </div>
                    <div class="contact-actions">
                        <button class="btn-edit" onclick="editContact(${index})">‚úèÔ∏è</button>
                        <button class="btn-delete" onclick="deleteContact(${index})">üóëÔ∏è</button>
                    </div>
                `;
                list.appendChild(item);
            });
        }

        // ========== CHIAMATE ==========
        let currentContact = null;

        function quickCall(contact) {
            currentContact = contact;
            
            // Chiamata RAPIDA (senza conferma) - solo se attivata
            if (contact.quickCall) {
                speak(`Chiamo ${contact.name}`);
                makeDirectCall(contact);
                return;
            }
            
            // Gestione emergenza con doppia conferma
            if (contact.phone === '112' || contact.name.includes('Emergenza')) {
                if (confirm('‚ö†Ô∏è ATTENZIONE!\n\nStai per chiamare il numero di EMERGENZA 112.\n\nConfermi la chiamata?')) {
                    makeDirectCall(contact);
                } else {
                    speak('Va bene. Chiamata annullata.');
                }
                return;
            }
            
            // Per altri contatti, chiedi conferma
            askForConfirmation(contact);
        }

        function askForConfirmation(contact) {
            hideAllScreens();
            document.getElementById('confirmText').innerHTML = 
                `CHIAMO ${contact.name.toUpperCase()}.<br>CONFERMI?`;
            speak(`Chiamo ${contact.name}. Confermi?`);
            showScreen('confirmScreen');
        }

        function confirmAction(confirmed) {
            if (confirmed) {
                speak("Va bene. Chiamo adesso.");
                makeDirectCall(currentContact);
            } else {
                speak("Va bene. Chiamata annullata.");
                resetToMain();
            }
        }

        function makeDirectCall(contact) {
            if (!contact.phone) {
                alert('Questo contatto non ha un numero di telefono salvato. Aggiungilo dalle impostazioni.');
                resetToMain();
                return;
            }

            hideAllScreens();
            document.getElementById('callingContact').textContent = contact.name.toUpperCase();
            showScreen('callingScreen');

            // Avvia chiamata reale
            setTimeout(() => {
                window.location.href = `tel:${contact.phone}`;
                setTimeout(resetToMain, 3000);
            }, 2000);
        }

        function cancelCall() {
            speak("Chiamata annullata.");
            resetToMain();
        }

        // ========== NAVIGAZIONE ==========
        function resetToMain() {
            hideAllScreens();
            document.getElementById('contactsGrid').classList.remove('hidden');
            currentContact = null;
        }

        function hideAllScreens() {
            const screens = ['contactsGrid', 'confirmScreen', 'callingScreen'];
            screens.forEach(id => {
                document.getElementById(id).classList.add('hidden');
            });
        }

        function showScreen(screenId) {
            document.getElementById(screenId).classList.remove('hidden');
        }

        // ========== TEXT-TO-SPEECH ==========
        function speak(text) {
            console.log("üó£Ô∏è Nonna dice:", text);
            
            if ('speechSynthesis' in window) {
                window.speechSynthesis.cancel();
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.lang = 'it-IT';
                utterance.rate = 0.75;
                utterance.pitch = 1.1;
                utterance.volume = 1.0;
                window.speechSynthesis.speak(utterance);
            }
        }

        // ========== INIZIALIZZAZIONE ==========
        document.addEventListener('DOMContentLoaded', () => {
            loadContacts();
            speak("Ciao. Sono Nonna. Premi un contatto per chiamare.");
        });
    </script>
</body>
</html>