<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Nonna</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: Arial, sans-serif;
            background: #000000;
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
        }

        .container {
            width: 100%;
            max-width: 500px;
            height: 100vh;
            background: #FFFFFF;
            display: flex;
            flex-direction: column;
            position: relative;
        }

        .header {
            background: #000000;
            color: #FFFF00;
            padding: 25px 20px;
            text-align: center;
            border-bottom: 5px solid #FFFF00;
            position: relative;
        }

        .header h1 {
            font-size: 48px;
            font-weight: bold;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
        }

        .header p {
            font-size: 26px;
            margin-top: 8px;
        }

        .settings-btn {
            position: absolute;
            top: 20px;
            right: 20px;
            background: #FFFF00;
            color: #000000;
            border: 3px solid #000000;
            padding: 12px 20px;
            font-size: 24px;
            font-weight: bold;
            border-radius: 10px;
            cursor: pointer;
        }

        .quick-call-toggle {
            position: absolute;
            top: 20px;
            left: 20px;
            background: #FF00FF;
            color: #000000;
            border: 3px solid #000000;
            padding: 12px 20px;
            font-size: 24px;
            font-weight: bold;
            border-radius: 10px;
            cursor: pointer;
        }

        .quick-call-toggle.active {
            background: #00FF00;
        }

        .main-screen {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 20px;
            position: relative;
            overflow-y: auto;
        }

        .status-text {
            font-size: 36px;
            font-weight: bold;
            text-align: center;
            color: #000000;
            margin-bottom: 30px;
            min-height: 80px;
            display: flex;
            align-items: center;
            justify-content: center;
            line-height: 1.3;
            text-shadow: 1px 1px 2px rgba(255,255,255,0.5);
        }

        .main-button {
            width: 260px;
            height: 260px;
            border-radius: 50%;
            border: 6px solid #000000;
            font-size: 38px;
            font-weight: bold;
            color: #000000;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 8px 20px rgba(0,0,0,0.4);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 12px;
        }

        .main-button.green {
            background: #FFFF00;
        }

        .main-button.red {
            background: #FF0000;
            color: #FFFFFF;
            border-color: #000000;
            width: 180px;
            height: 180px;
            font-size: 32px;
        }

        .icon {
            font-size: 80px;
            filter: drop-shadow(2px 2px 3px rgba(0,0,0,0.3));
        }

        .contacts-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            padding: 15px;
            width: 100%;
            max-width: 500px;
            overflow-y: auto;
            max-height: calc(100vh - 200px);
        }

        .contact-btn {
            background: #FFFFFF;
            border: 5px solid #000000;
            border-radius: 20px;
            padding: 25px 15px;
            font-size: 26px;
            font-weight: bold;
            color: #000000;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 12px;
            min-height: 160px;
            box-shadow: 0 6px 15px rgba(0,0,0,0.3);
            position: relative;
        }

        .contact-btn.yellow { background: #FFFF00; }
        .contact-btn.cyan { background: #00FFFF; }
        .contact-btn.magenta { background: #FF00FF; }
        .contact-btn.orange { background: #FF9900; }
        .contact-btn.lime { background: #00FF00; }
        .contact-btn.pink { background: #FF69B4; }
        .contact-btn.violet { background: #9933FF; }
        .contact-btn.gold { background: #FFD700; }

        .contact-btn:active {
            transform: scale(0.95);
            box-shadow: 0 3px 10px rgba(0,0,0,0.4);
        }

        .contact-icon {
            font-size: 52px;
            filter: drop-shadow(2px 2px 3px rgba(0,0,0,0.3));
        }

        .contact-name {
            font-size: 24px;
            text-align: center;
            line-height: 1.2;
        }

        .add-contact-btn {
            background: #00FF00;
            border: 5px dashed #000000;
        }

        .hidden {
            display: none !important;
        }

        .response-options {
            display: flex;
            gap: 20px;
            margin-top: 25px;
            width: 100%;
            max-width: 400px;
        }

        .response-btn {
            flex: 1;
            padding: 30px;
            font-size: 40px;
            font-weight: bold;
            border: 5px solid #000000;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: 0 6px 15px rgba(0,0,0,0.3);
        }

        .response-btn.yes {
            background: #00FF00;
            color: #000000;
        }

        .response-btn.no {
            background: #FF0000;
            color: #FFFFFF;
        }

        .response-btn:active {
            transform: scale(0.95);
        }

        .calling-animation {
            width: 180px;
            height: 180px;
            border: 10px solid #000000;
            background: #FFFF00;
            border-radius: 50%;
            margin: 20px auto;
            position: relative;
            animation: ring 1s infinite;
        }

        @keyframes ring {
            0%, 100% {
                transform: scale(1);
                box-shadow: 0 0 30px rgba(255, 255, 0, 0.8);
            }
            50% {
                transform: scale(1.1);
                box-shadow: 0 0 50px rgba(255, 255, 0, 1);
            }
        }

        .calling-animation::before {
            content: "üìû";
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 70px;
        }

        .modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .modal-content {
            background: #FFFFFF;
            border: 5px solid #FFFF00;
            border-radius: 20px;
            padding: 30px;
            width: 90%;
            max-width: 450px;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-title {
            font-size: 32px;
            font-weight: bold;
            color: #000000;
            margin-bottom: 20px;
            text-align: center;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            font-size: 24px;
            font-weight: bold;
            color: #000000;
            display: block;
            margin-bottom: 10px;
        }

        .form-input {
            width: 100%;
            padding: 15px;
            font-size: 22px;
            border: 3px solid #000000;
            border-radius: 10px;
            background: #FFFF00;
            color: #000000;
            font-weight: bold;
        }

        .form-select {
            width: 100%;
            padding: 15px;
            font-size: 22px;
            border: 3px solid #000000;
            border-radius: 10px;
            background: #00FFFF;
            color: #000000;
            font-weight: bold;
        }

        .btn-save {
            background: #00FF00;
            color: #000000;
            border: 5px solid #000000;
            padding: 20px;
            font-size: 28px;
            font-weight: bold;
            border-radius: 15px;
            cursor: pointer;
            width: 100%;
            margin-top: 20px;
        }

        .btn-cancel {
            background: #FF0000;
            color: #FFFFFF;
            border: 5px solid #000000;
            padding: 20px;
            font-size: 28px;
            font-weight: bold;
            border-radius: 15px;
            cursor: pointer;
            width: 100%;
            margin-top: 10px;
        }

        .btn-secondary {
            background: #00FFFF;
            color: #000000;
            border: 5px solid #000000;
            padding: 20px;
            font-size: 24px;
            font-weight: bold;
            border-radius: 15px;
            cursor: pointer;
            width: 100%;
            margin-top: 10px;
        }

        .contact-list {
            margin-top: 20px;
            max-height: 300px;
            overflow-y: auto;
        }

        .contact-item {
            background: #FFFF00;
            border: 3px solid #000000;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .contact-info {
            font-size: 20px;
            font-weight: bold;
        }

        .btn-delete {
            background: #FF0000;
            color: #FFFFFF;
            border: 3px solid #000000;
            padding: 10px 15px;
            font-size: 20px;
            font-weight: bold;
            border-radius: 8px;
            cursor: pointer;
        }

        .settings-section {
            margin: 20px 0;
            padding: 20px;
            background: #F0F0F0;
            border: 3px solid #000000;
            border-radius: 15px;
        }

        .settings-title {
            font-size: 26px;
            font-weight: bold;
            margin-bottom: 15px;
            color: #000000;
        }

        .info-text {
            font-size: 18px;
            color: #333;
            margin: 10px 0;
            line-height: 1.4;
        }

        .btn-group {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .btn-small {
            flex: 1;
            background: #00FFFF;
            color: #000000;
            border: 3px solid #000000;
            padding: 15px;
            font-size: 20px;
            font-weight: bold;
            border-radius: 10px;
            cursor: pointer;
        }

        input[type="file"] {
            display: none;
        }

        .high-contrast {
            filter: contrast(1.2);
        }

        .quick-mode-banner {
            background: #00FF00;
            color: #000000;
            text-align: center;
            padding: 15px;
            font-size: 24px;
            font-weight: bold;
            border-bottom: 5px solid #000000;
        }
    </style>
</head>
<body>
    <div class="container high-contrast">
        <div class="header">
            <button class="quick-call-toggle" id="quickToggle" onclick="toggleQuickMode()">‚ö°</button>
            <h1>üëµ NONNA</h1>
            <p>Assistente Vocale</p>
            <button class="settings-btn" onclick="openSettings()">‚öôÔ∏è</button>
        </div>

        <div class="quick-mode-banner hidden" id="quickBanner">
            ‚ö° MODALIT√Ä RAPIDA ATTIVA ‚ö°
        </div>

        <!-- Griglia Contatti -->
        <div class="contacts-grid" id="contactsGrid">
            <button class="contact-btn add-contact-btn" onclick="addNewContact()">
                <span class="contact-icon">‚ûï</span>
                <span class="contact-name">AGGIUNGI<br>CONTATTO</span>
            </button>
        </div>

        <!-- Schermata Conferma -->
        <div class="main-screen hidden" id="confirmScreen">
            <div class="status-text" id="confirmText">
                CHIAMO MARIA.<br>CONFERMI?
            </div>
            <div class="response-options">
                <button class="response-btn yes" onclick="confirmAction(true)">
                    S√å
                </button>
                <button class="response-btn no" onclick="confirmAction(false)">
                    NO
                </button>
            </div>
        </div>

        <!-- Schermata Chiamata -->
        <div class="main-screen hidden" id="callingScreen">
            <div class="status-text">
                CHIAMO ADESSO...
            </div>
            <div class="calling-animation"></div>
            <div class="status-text" id="callingContact" style="font-size: 48px; color: #000000;">
                MARIA
            </div>
            <button class="main-button red" onclick="cancelCall()" style="margin-top: 30px;">
                ANNULLA
            </button>
        </div>
    </div>

    <!-- Modal Impostazioni -->
    <div class="modal hidden" id="settingsModal">
        <div class="modal-content">
            <div class="modal-title">‚öôÔ∏è IMPOSTAZIONI</div>
            
            <!-- Sezione Import Contatti -->
            <div class="settings-section">
                <div class="settings-title">üì± IMPORTA DALLA RUBRICA</div>
                <div class="info-text">
                    Importa i contatti direttamente dalla rubrica del telefono.
                </div>
                <button class="btn-secondary" onclick="importFromPhoneBook()">
                    üì• IMPORTA CONTATTI
                </button>
            </div>

            <!-- Sezione Backup/Ripristino -->
            <div class="settings-section">
                <div class="settings-title">üíæ BACKUP E RIPRISTINO</div>
                <div class="info-text">
                    Salva i tuoi contatti o ripristinali da un backup precedente.
                </div>
                <div class="btn-group">
                    <button class="btn-small" onclick="exportContacts()">
                        üíæ ESPORTA
                    </button>
                    <button class="btn-small" onclick="document.getElementById('importFile').click()">
                        üìÇ IMPORTA
                    </button>
                </div>
                <input type="file" id="importFile" accept=".json" onchange="importContacts(event)">
            </div>

            <!-- Sezione Modalit√† Rapida -->
            <div class="settings-section">
                <div class="settings-title">‚ö° MODALIT√Ä RAPIDA</div>
                <div class="info-text">
                    Quando attiva, chiama immediatamente senza conferma. Utile per caregiver esperti.
                </div>
                <button class="btn-secondary" onclick="toggleQuickModeFromSettings()">
                    <span id="quickModeStatus">ATTIVA MODALIT√Ä RAPIDA</span>
                </button>
            </div>

            <!-- Lista Contatti -->
            <div class="settings-section">
                <div class="settings-title">üìã I TUOI CONTATTI</div>
                <div class="contact-list" id="contactList"></div>
            </div>
            
            <button class="btn-save" onclick="closeSettings()">CHIUDI</button>
        </div>
    </div>

    <!-- Modal Aggiungi Contatto -->
    <div class="modal hidden" id="addContactModal">
        <div class="modal-content">
            <div class="modal-title">‚ûï AGGIUNGI CONTATTO</div>
            
            <div class="form-group">
                <label class="form-label">NOME:</label>
                <input type="text" class="form-input" id="contactName" placeholder="Es: Maria">
            </div>
            
            <div class="form-group">
                <label class="form-label">NUMERO TELEFONO:</label>
                <input type="tel" class="form-input" id="contactPhone" placeholder="Es: 3331234567">
            </div>
            
            <div class="form-group">
                <label class="form-label">ICONA:</label>
                <select class="form-select" id="contactIcon">
                    <option value="üë®">üë® Uomo</option>
                    <option value="üë©">üë© Donna</option>
                    <option value="üëß">üëß Bambina</option>
                    <option value="üë¶">üë¶ Bambino</option>
                    <option value="üëµ">üëµ Nonna</option>
                    <option value="üë¥">üë¥ Nonno</option>
                    <option value="üë©‚Äç‚öïÔ∏è">üë©‚Äç‚öïÔ∏è Dottoressa</option>
                    <option value="üë®‚Äç‚öïÔ∏è">üë®‚Äç‚öïÔ∏è Dottore</option>
                    <option value="üíä">üíä Farmacia</option>
                    <option value="üö®">üö® Emergenza</option>
                    <option value="‚ù§Ô∏è">‚ù§Ô∏è Cuore</option>
                    <option value="‚≠ê">‚≠ê Stella</option>
                </select>
            </div>
            
            <div class="form-group">
                <label class="form-label">COLORE:</label>
                <select class="form-select" id="contactColor">
                    <option value="yellow">Giallo</option>
                    <option value="cyan">Ciano</option>
                    <option value="magenta">Magenta</option>
                    <option value="orange">Arancione</option>
                    <option value="lime">Verde Lime</option>
                    <option value="pink">Rosa</option>
                    <option value="violet">Viola</option>
                    <option value="gold">Oro</option>
                </select>
            </div>
            
            <button class="btn-save" onclick="saveContact()">SALVA</button>
            <button class="btn-cancel" onclick="closeAddContact()">ANNULLA</button>
        </div>
    </div>

    <!-- Modal Importa dalla Rubrica -->
    <div class="modal hidden" id="phoneBookModal">
        <div class="modal-content">
            <div class="modal-title">üì± SELEZIONA CONTATTI</div>
            <div class="info-text" style="margin-bottom: 20px;">
                Seleziona i contatti dalla tua rubrica da aggiungere:
            </div>
            <div class="contact-list" id="phoneBookList"></div>
            <button class="btn-save" onclick="closePhoneBook()">CHIUDI</button>
        </div>
    </div>

    <script>
        let contacts = [];
        let quickCallMode = false;

        // Carica contatti salvati
        function loadContacts() {
            const saved = localStorage.getItem('nonnaContacts');
            if (saved) {
                contacts = JSON.parse(saved);
            } else {
                contacts = [
                    { name: 'Emergenza 112', phone: '112', icon: 'üö®', color: 'gold' }
                ];
                saveContactsToStorage();
            }
            
            // Carica modalit√† rapida
            quickCallMode = localStorage.getItem('nonnaQuickMode') === 'true';
            updateQuickModeUI();
            
            renderContacts();
        }

        // Salva contatti
        function saveContactsToStorage() {
            localStorage.setItem('nonnaContacts', JSON.stringify(contacts));
        }

        // Renderizza contatti
        function renderContacts() {
            const grid = document.getElementById('contactsGrid');
            grid.innerHTML = '';

            contacts.forEach((contact, index) => {
                const btn = document.createElement('button');
                btn.className = `contact-btn ${contact.color}`;
                btn.onclick = () => quickCall(contact);
                btn.innerHTML = `
                    <span class="contact-icon">${contact.icon}</span>
                    <span class="contact-name">${contact.name.toUpperCase()}</span>
                `;
                grid.appendChild(btn);
            });

            const addBtn = document.createElement('button');
            addBtn.className = 'contact-btn add-contact-btn';
            addBtn.onclick = addNewContact;
            addBtn.innerHTML = `
                <span class="contact-icon">‚ûï</span>
                <span class="contact-name">AGGIUNGI<br>CONTATTO</span>
            `;
            grid.appendChild(addBtn);
        }

        // Modalit√† chiamata rapida
        function toggleQuickMode() {
            quickCallMode = !quickCallMode;
            localStorage.setItem('nonnaQuickMode', quickCallMode);
            updateQuickModeUI();
            speak(quickCallMode ? 'Modalit√† rapida attivata' : 'Modalit√† rapida disattivata');
        }

        function toggleQuickModeFromSettings() {
            toggleQuickMode();
            document.getElementById('quickModeStatus').textContent = 
                quickCallMode ? 'DISATTIVA MODALIT√Ä RAPIDA' : 'ATTIVA MODALIT√Ä RAPIDA';
        }

        function updateQuickModeUI() {
            const toggle = document.getElementById('quickToggle');
            const banner = document.getElementById('quickBanner');
            
            if (quickCallMode) {
                toggle.classList.add('active');
                banner.classList.remove('hidden');
            } else {
                toggle.classList.remove('active');
                banner.classList.add('hidden');
            }
        }

        // Importa dalla rubrica del telefono (Web API)
        async function importFromPhoneBook() {
            if (!('contacts' in navigator)) {
                alert('Il tuo browser non supporta l\'accesso ai contatti. Questa funzione √® disponibile solo su Android con Chrome/Edge.');
                return;
            }

            try {
                const props = ['name', 'tel'];
                const opts = { multiple: true };
                
                const phoneContacts = await navigator.contacts.select(props, opts);
                
                if (phoneContacts && phoneContacts.length > 0) {
                    showPhoneBookSelection(phoneContacts);
                } else {
                    alert('Nessun contatto selezionato');
                }
            } catch (error) {
                console.error('Errore importazione contatti:', error);
                alert('Non √® stato possibile accedere ai contatti. Verifica i permessi dell\'app.');
            }
        }

        // Mostra selezione contatti dalla rubrica
        function showPhoneBookSelection(phoneContacts) {
            const list = document.getElementById('phoneBookList');
            list.innerHTML = '';

            phoneContacts.forEach(contact => {
                if (!contact.tel || contact.tel.length === 0) return;

                const phone = contact.tel[0]; // Prendi il primo numero
                const name = contact.name && contact.name[0] ? contact.name[0] : 'Sconosciuto';

                const item = document.createElement('div');
                item.className = 'contact-item';
                item.innerHTML = `
                    <div class="contact-info">
                        üë§ ${name}<br>
                        <small>${phone}</small>
                    </div>
                    <button class="btn-save" style="width: auto; padding: 10px 20px; margin: 0;" 
                            onclick="addPhoneBookContact('${name.replace(/'/g, "\\'")}', '${phone}')">
                        ‚ûï
                    </button>
                `;
                list.appendChild(item);
            });

            document.getElementById('phoneBookModal').classList.remove('hidden');
        }

        // Aggiungi contatto dalla rubrica
        function addPhoneBookContact(name, phone) {
            // Controlla se esiste gi√†
            if (contacts.some(c => c.phone === phone)) {
                alert(`${name} √® gi√† nei tuoi contatti!`);
                return;
            }

            // Assegna icona e colore automatici
            const colors = ['yellow', 'cyan', 'magenta', 'orange', 'lime', 'pink', 'violet', 'gold'];
            const icons = ['üë®', 'üë©', 'üëß', 'üë¶', 'üëµ', 'üë¥'];
            
            contacts.push({
                name: name,
                phone: phone,
                icon: icons[Math.floor(Math.random() * icons.length)],
                color: colors[Math.floor(Math.random() * colors.length)]
            });

            saveContactsToStorage();
            renderContacts();
            speak(`${name} aggiunto`);
        }

        function closePhoneBook() {
            document.getElementById('phoneBookModal').classList.add('hidden');
        }

        // Esporta contatti (Backup)
        function exportContacts() {
            const dataStr = JSON.stringify(contacts, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            
            const link = document.createElement('a');
            link.href = URL.createObjectURL(dataBlob);
            link.download = `nonna_contatti_backup_${new Date().toISOString().split('T')[0]}.json`;
            link.click();
            
            speak('Backup creato');
            alert('Backup salvato! Conserva questo file in un luogo sicuro.');
        }

        // Importa contatti (Ripristino)
        function importContacts(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const imported = JSON.parse(e.target.result);
                    
                    if (!Array.isArray(imported)) {
                        throw new Error('Formato file non valido');
                    }

                    // Chiedi conferma
                    if (confirm(`Trovati ${imported.length} contatti nel backup. Vuoi sostituire i contatti attuali o aggiungerli?

OK = Sostituisci tutto
ANNULLA = Aggiungi ai contatti esistenti`)) {
                        contacts = imported;
                    } else {
                        // Aggiungi senza duplicati
                        imported.forEach(imp => {
                            if (!contacts.some(c => c.phone === imp.phone)) {
                                contacts.push(imp);
                            }
                        });
                    }

                    saveContactsToStorage();
                    renderContacts();
                    speak('Contatti ripristinati');
                    alert('Contatti importati con successo!');
                    closeSettings();
                } catch (error) {
                    alert('Errore nel file di backup. Verifica che sia un file valido.');
                    console.error(error);
                }
            };
            reader.readAsText(file);
        }

        // Aggiungi nuovo contatto
        function addNewContact() {
            document.getElementById('contactName').value = '';
            document.getElementById('contactPhone').value = '';
            document.getElementById('contactIcon').value = 'üë®';
            document.getElementById('contactColor').value = 'yellow';
            document.getElementById('addContactModal').classList.remove('hidden');
        }

        // Salva contatto
        function saveContact() {
            const name = document.getElementById('contactName').value.trim();
            const phone = document.getElementById('contactPhone').value.trim();
            const icon = document.getElementById('contactIcon').value;
            const color = document.getElementById('contactColor').value;

            if (!name) {
                alert('Inserisci un nome per il contatto!');
                return;
            }

            if (!phone) {
                alert('Inserisci un numero di telefono!');
                return;
            }

            contacts.push({ name, phone, icon, color });
            saveContactsToStorage();
            renderContacts();
            closeAddContact();
            speak(`Contatto ${name} aggiunto`);
        }

        function closeAddContact() {
            document.getElementById('addContactModal').classList.add('hidden');
        }

        // Apri/chiudi impostazioni
        function openSettings() {
            renderContactList();
            document.getElementById('quickModeStatus').textContent = 
                quickCallMode ? 'DISATTIVA MODALIT√Ä RAPIDA' : 'ATTIVA MODALIT√Ä RAPIDA';
            document.getElementById('settingsModal').classList.remove('hidden');
        }

        function closeSettings() {
            document.getElementById('settingsModal').classList.add('hidden');
        }

        // Renderizza lista contatti nelle impostazioni
        function renderContactList() {
            const list = document.getElementById('contactList');
            list.innerHTML = '';

            if (contacts.length === 0) {
                list.innerHTML = '<p style="text-align:center; font-size:20px;">Nessun contatto salvato</p>';
                return;
            }

            contacts.forEach((contact, index) => {
                const item = document.createElement('div');
                item.className = 'contact-item';
                item.innerHTML = `
                    <div class="contact-info">
                        ${contact.icon} ${contact.name}<br>
                        <small>${contact.phone}</small>
                    </div>
                    <button class="btn-delete" onclick="deleteContact(${index})">üóëÔ∏è</button>
                `;
                list.appendChild(item);
            });
        }

        // Elimina contatto
        function deleteContact(index) {
            if (confirm(`Vuoi eliminare ${contacts[index].name}?`)) {
                const deletedName = contacts[index].name;
                contacts.splice(index, 1);
                saveContactsToStorage();
                renderContacts();
                renderContactList();
                speak(`Contatto ${deletedName} eliminato`);
            }
        }

        // Chiamata rapida
        let currentContact = null;

        function quickCall(contact) {
            currentContact = contact;
            
            // Modalit√† rapida: chiama subito senza conferma
            if (quickCallMode && contact.phone !== '112' && !contact.name.includes('Emergenza')) {
                makeDirectCall(contact);
                return;
            }
            
            // Emergenza sempre con conferma
            if (contact.phone === '112' || contact.name.includes('Emergenza')) {
                if (confirm('ATTENZIONE!\n\nStai per chiamare il numero di emergenza 112.\n\nConfermi la chiamata?')) {
                    makeDirectCall(contact);
                } else {
                    speak('Va bene. Chiamata annullata.');
                }
                return;
            }
            
            // Modalit√† normale: chiedi conferma
            askForConfirmation(contact);
        }

        function askForConfirmation(contact) {
            hideAllScreens();
            document.getElementById('confirmText').innerHTML = 
                `CHIAMO ${contact.name.toUpperCase()}.<br>CONFERMI?`;
            speak(`Chiamo ${contact.name}. Confermi?`);
            showScreen('confirmScreen');
        }

        function confirmAction(confirmed) {
            if (confirmed) {
                speak("Va bene. Chiamo adesso.");
                makeDirectCall(currentContact);
            } else {
                speak("Va bene. Chiamata annullata.");
                resetToMain();
            }
        }

        // Effettua chiamata reale
        function makeDirectCall(contact) {
            if (!contact.phone) {
                alert('Questo contatto non ha un numero di telefono salvato.');
                resetToMain();
                return;
            }

            hideAllScreens();
            document.getElementById('callingContact').textContent = contact.name.toUpperCase();
            showScreen('callingScreen');

            setTimeout(() => {
                window.location.href = `tel:${contact.phone}`;
                setTimeout(resetToMain, 3000);
            }, 2000);
        }

        function cancelCall() {
            speak("Chiamata annullata.");
            resetToMain();
        }

        function resetToMain() {
            hideAllScreens();
            document.getElementById('contactsGrid').classList.remove('hidden');
            currentContact = null;
        }

        function hideAllScreens() {
            const screens = ['contactsGrid', 'confirmScreen', 'callingScreen'];
            screens.forEach(id => {
                document.getElementById(id).classList.add('hidden');
            });
        }

        function showScreen(screenId) {
            document.getElementById(screenId).classList.remove('hidden');
        }

        // Text-to-Speech
        function speak(text) {
            console.log("üó£Ô∏è Nonna dice:", text);
            
            if ('speechSynthesis' in window) {
                window.speechSynthesis.cancel();
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.lang = 'it-IT';
                utterance.rate = 0.75;
                utterance.pitch = 1.1;
                utterance.volume = 1.0;
                window.speechSynthesis.speak(utterance);
            }
        }

        // Inizializzazione
        document.addEventListener('DOMContentLoaded', () => {
            loadContacts();
            speak("Ciao. Sono Nonna. Premi un contatto per chiamare.");
        });
    </script>
</body>
</html>